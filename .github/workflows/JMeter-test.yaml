on:
  push:
    branches: [ main ]

jobs:
  test-Jmeter-Pipeline:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install JMeter
        run: |
          wget https://downloads.apache.org//jmeter/binaries/apache-jmeter-5.4.1.zip
          unzip apache-jmeter-5.4.1.zip
          cd apache-jmeter-5.4.1/bin

      - name: Install jpgc-dummy Plugin
        run: |
          wget https://jmeter-plugins.org/files/packages/jpgc-dummy-0.4.zip
          unzip jpgc-dummy-0.4.zip
          jmeter/bin/PluginsManagerCMD.sh --install jpgc-dummy-0.4.jar

      - name: Copy Test Files
        run: |
          cp your_test_plan.jmx jmeter/bin/

      - name: Run Test Plan
        run: |
          jmeter/bin/jmeter -n -t your_test_plan.jmx -l results.jtl

      - name: Convert JTL to CSV
        run: |
          jmeter/bin/JMeterPluginsCMD --generate-csv results.csv --input-jtl results.jtl

      - name: Analyze "error %" column
        run: |
          awk -F, '{ if ($9 > 2) { print "Error percentage exceeds 2% for request: " $2 } }' results.csv > errors.txt

      - name: Upload Results (Optional)
        uses: actions/upload-artifact@v3
        with:
          name: jmeter-results
          path: results.csv,errors.txt

